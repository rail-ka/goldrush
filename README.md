# Gold Rush

## Условия

Уже давно мы не слышали авантюрных историй о кладоискателях... А все потому что время неожиданных приключений, к сожалению, закончилось!

Все теперь под отчетом, банки контролируют все раскопки, в мире царит порядок и равенство возможностей.

Но даже здесь есть место риску и возможности быстро обогатиться! Главное - выбрать правильную стратегию и быть готовым адаптироваться к изменениям.

Представьте, вы путешествуете по миру с другими кладоискателями. Приезжая на раскопки каждый раз у вас одна цель - собрать как можно больше золота за отведенное время и не дать конкурентам ни шанса на победу. При этом, за все время путешествий ваше оборудование сильно износилось и уже не может работать также быстро, как и раньше, может глючить и зависать в работе.

## Описание задачи

Вам дано трехмерное игровое поле размером 3500х3500 клеток, в котором закопаны клады на глубине от 1 до 10 этажей.

Основная задача — добыть как можно больше монет за отведенное время (см. ограничения на решение).

Вам необходимо написать приложение, упакованное в контейнер типа Docker, отвечающее требованиям задачи и умеющее делать запросы в API нашего сервера - игрового мира.

## Генерация мира

Технически организаторами соревнования разработано сервер-приложение, которое работает по определенной бизнес-логике.

При генерации мира используется параметр SEED. Он определяет сколько кладов и на каком этаже будет сгенерировано, какая будет ценность каждого клада и какой этаж будет оптимальным по соотношению ценности кладов к стоимости их добычи.

Кроме того, игровой мир имитирует среду. Вы можете встретить разные ошибки, которые зависят от времени (CPU_TIME) и RPS игрового мира, и конкретно CPU_TIME и RPS на каждый ENDPOINT игрового мира. От этого зависят вероятности возникновения ошибок, и их вам нужно исследовать.

Обратите внимание, что исходный код сервера и параметр SEED во время проведения соревнования публиковаться не будут.

В этом раунде гарантированно будет:

- 490 000 кладов;
- 23 030 000 монет лежит в кладах.

## Сущности игрового мира

1. Клад (то, что нужно найти и даёт монеты);
2. Лицензии (то, что позволяет нам копать), которые делятся на две категории - бесплатные и платные;
3. Монеты (массив монет, который позволяет нам покупать лицензии).

## Игровой процесс

Вам необходимо найти клады в игровом поле, которое по сути является трехмерным пространством. Чтобы найти клад, вам нужно копать, при этом копать можно только в глубину. Обязательным условием для операции "копать" является наличие активной лицензии, которые бывают бесплатные или платные.

Активная лицензии должна иметь положительное значение количества копаний, поэтому их можно использовать несколько раз для копания, при этом количество копаний для бесплатных лицензий равно 3, а для платных всегда разное и зависит от количество монет, потраченных на покупку лицензии. Лицензия деактивируется после того, как исчерпано все количество копаний.

Покупать лицензии можно за монеты, которые вы получаете после обналичивания клада.

## API игрового мира

Для поиска вам дано API с POST запросом /explore, позволяющие исследовать поле в координатах X, Y. По этим координатам на определенном этаже могут быть закопаны клады, которые содержат какое-то количество монет. Чем больше область поиска, тем больше уйдет времени на ее исследование и будет выше вероятность ошибки.

API запросом POST /dig, которая принимает в себя координаты и ID лицензии, позволяет прокопать глубину на 1 этаж вниз. В случае, если по данным координатам и на текущей глубине лежит клад, то вы его выкопаете, уменьшите количество копаний у активной лицензии и прокопаете глубину на 1 этаж вниз. Если клада не было, то вы получите ошибку 404, уменьшите количество копаний у активной лицензии и также прокопаете глубину на 1 этаж вниз. Чтобы выкопать клад на 10 этаже необходимо последовательно прокопать остальные 9 этажей. Копать в стороны нельзя. Прокопанные ячейки остаются всегда прокопанными. Чем глубже раскопки, тем больше нужно времени на один вызов API. По мере продвижения вглубь увеличивается количество монет в каждом кладе. На 10 этаже оно достигает максимального значения. Но, следует учитывать, что при разных параметрах игрового мира **SEED** оптимальный этаж по соотношению ценности клада к стоимости его добычи будет изменяться.

Получить лицензию можно через API запросом POST /licenses. Чтобы получить бесплатную лицензию необходимо передать в API запросом POST /licenses пустой запрос, а для платной лицензии нужно передать еще ID монет, которые вы хотите потратить на ее покупку. Одну монету нельзя потратить дважды. Бесплатная лицензия всегда позволяет прокопать глубину 3 раза и у нее увеличен шанс получения 5хх ошибок при их запросе. Платная лицензия предоставляет возможность по определенной закономерности получить N-копаний за X количества монет, которые вы потратите на ее приобретение. Прайс-лист монет неизвестен, и вам лучше его определить.

Баланс - это длина массива монет. Для уточнения баланса существует API запросом GET /balance, но использовать его необязательно. Баланс является метрикой эффективности вашего решения. Баланс равняется количеству заработанных очков (SCORE).

Обменять найденные клады можно используя API POST /cash. В результате обмена кладов вы получаете монеты, которые отражаются на вашем балансе по результатам работы вашего решения. Обратите внимание: если вы тратите заработанные монеты на покупку платных лицензий, то ваш общий SCORE соответственно уменьшается.

Мы обращаем ещё раз ваше внимание на то, что в игровом мире намеренно заложена определенная вероятность получения ошибок на любой запрос. В отдельных ситуациях вам полезно будет не ждать ответа слишком долго, а попробовать повторить запрос снова.

Ваше решение будет наиболее успешно, если у вас получится одновременно выполнять несколько различных действий. Но следует учесть, что порой очень частые запросы дают негативный эффект.

Полное описание API доступно в файле [swagger.yaml](https://github.com/All-Cups/highloadcup/blob/main/goldrush/swagger.yaml) в репозитории чемпионата.

## Логирование и мониторинг

Мы не планируем отдавать полные логи вашего решения для обеспечения честной игры.

Каждое запущенное решение вы можете смотреть в Grafana. В Grafana вы не можете менять дашборд. В ней доступна информация по контейнерам, а также появится информация, собранная Prometheus, по контейнеру игрового мира (client-golang) с метриками, входящими в данный клиент, а также будут выведены некоторые кастомные метрики игрового мира, а именно:

1. task_build_info — версия приложения;
2. panics_total — сколько паник заглушили (идеально - 0);
3. task_openapi_http_request* — стандартные 4 golden signals;
4. task_app_autosave_duration_seconds — latency для периодически вызываемого сохранения промежуточных результатов на винт (на случай крашей или рестартов).

Мы работаем над выводом метрик.

## Результат игры

Результатом игры является баланс на момент завершения игровой сессии, он же является SCORE.

## Техническая информация

Для запуска сервис должен быть обернут в Docker-контейнер.

Передаваемые environments:

```
ADDRESS: default
Port: 8000;
Schema: http
```

Пример обработки в Python:

```
address = os.getenv('ADDRESS')
base_url = URL.build(scheme='http', host=address, port=8000)
```

Пример решения доступен в репозитории Github:

```
$ git clone <https://github.com/All-Cups/highloadcup.git>
или
$ gh repo clone All-Cups/highloadcup
```

## Ограничения на решения

В этом раунде:

— вашему решению даётся 10 минут на выполнение. Распоряжайтесь выделенным временем самостоятельно.

— мы не просим вас собирать решение в контейнере, вы можете его собирать локально и отправлять в контейнере уже как собранный файл, но учтите, что в финальном раунде будет требоваться сборка решения в контейнере.

— мы не установили ограничения на загрузку решений в день. В зависимости от нагрузки на систему обсчета мы можем ограничить загрузку решений до 50 в день на одного пользователя.

Каждому решению гарантированно выделяются ресурсы:

```
Cores: 4
RAM: 2048 MB
Swap: 2048 MB
Timeout: 900 Sec
```

Сервер, к которому вы делаете запросы, имеет технические характеристики:

```
Language: golang
Cores: 2
RAM: 2048 MB
SWAP: 2048 MB
Timeout: 900 Sec
```

Сервер вы должны проверять сами, готов он или нет. Если в течение 900 секунд сервер не получает запросы на ключевые endpoint, игровая сессия завершается.

Желаем удачи!
